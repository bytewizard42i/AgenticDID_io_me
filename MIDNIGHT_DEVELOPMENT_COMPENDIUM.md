# üåô Midnight Network Development Compendium

**Compiled from**: 24 official Midnight repositories  
**Date**: October 28, 2025  
**Purpose**: Complete guide for building on Midnight Network  
**Source**: `/home/js/utils_Midnight/Midnight_reference_repos/`

---

## üìö Table of Contents

1. [Critical Version Information](#critical-version-information)
2. [Outdated Information & Warnings](#outdated-information--warnings)
3. [Project Setup](#project-setup)
4. [Compact Smart Contracts](#compact-smart-contracts)
5. [Midnight.js SDK](#midnightjs-sdk)
6. [Wallet Integration](#wallet-integration)
7. [Proof Server](#proof-server)
8. [Testing & Debugging](#testing--debugging)
9. [Deployment](#deployment)
10. [Best Practices](#best-practices)
11. [Common Patterns](#common-patterns)
12. [Troubleshooting](#troubleshooting)

---

## üéØ Critical Version Information

### **Current Stable Versions** (from official examples)

| Component | Version | Status | Notes |
|-----------|---------|--------|-------|
| **Compact Compiler** | **0.25.0** | ‚úÖ Stable | All examples use this |
| **Language Version** | **>= 0.16 && <= 0.18** | ‚úÖ Range | Use range syntax |
| **midnight-js** | **2.0.2** | ‚úÖ Stable | Latest SDK |
| **compact-runtime** | **0.9.0** | ‚úÖ Stable | Core runtime |
| **wallet** | **5.0.0** | ‚úÖ Stable | Wallet API |
| **Node.js** | **22.15.0+** | ‚úÖ Required | Minimum version |
| **Docker** | **20.0.0+** | ‚úÖ Required | For proof server |

### **Version Matrix from Examples**

```
example-counter:  Compiler 0.25.0 + Language >= 0.16 && <= 0.18 ‚úÖ
example-bboard:   Compiler 0.23.0 + Language >= 0.16 && <= 0.17 ‚úÖ
example-proofshare: Language >= 0.16 && <= 0.17 ‚úÖ
```

---

## ‚ö†Ô∏è Outdated Information & Warnings

### **Compiler v0.26.0 Issues**

**CRITICAL BUG**: compactc v0.26.0 has a regression with `Address` type resolution
- ‚ùå Causes "unbound identifier Address" errors
- ‚ùå Affects contracts with multiple circuits
- ‚úÖ **Recommendation**: Use v0.25.0 until fixed
- üìã Bug reported: https://github.com/midnightntwrk/compact/issues

### **Pragma Syntax**

**ALWAYS use range syntax:**
```compact
‚úÖ CORRECT: pragma language_version >= 0.16 && <= 0.18;
‚ùå AVOID:   pragma language_version 0.18;
```

**Why**: All official examples use range syntax. Exact versions may cause compiler issues.

### **Outdated Patterns**

From older repos (pre-2025):
- ‚ùå `Bool` type ‚Üí Use `Boolean` (changed in 0.18)
- ‚ùå `let` bindings ‚Üí Use `const` (changed in 0.18)
- ‚ùå Old SDK imports ‚Üí Use `@midnight-ntwrk/*` packages

---

## üöÄ Project Setup

### **1. Prerequisites**

```bash
# Check Node.js version
node --version  # Should be >= 22.15.0

# Check Docker
docker --version  # Should be >= 20.0.0

# Install Compact Compiler (v0.25.0 recommended)
curl --proto '=https' --tlsv1.2 -LsSf \
  https://github.com/midnightntwrk/compact/releases/latest/download/compact-installer.sh | sh

# Add to PATH
source $HOME/.local/bin/env  # bash/zsh
source $HOME/.local/bin/env.fish  # fish

# Verify installation
compact compile --version  # Should show 0.25.0
```

### **2. Project Structure**

**Standard Midnight Project Layout:**

```
my-midnight-dapp/
‚îú‚îÄ‚îÄ contract/                    # Smart contracts
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mycontract.compact  # Your Compact contract
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ managed/            # Generated by compiler (gitignore)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ test/               # Contract unit tests
‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îî‚îÄ‚îÄ tsconfig.json
‚îÇ
‚îú‚îÄ‚îÄ api/                         # Shared API types (optional)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ methods.ts
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îú‚îÄ‚îÄ cli/                         # CLI interface
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îú‚îÄ‚îÄ ui/                          # Web UI (optional)
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ App.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ components/
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îÇ
‚îú‚îÄ‚îÄ package.json                 # Root workspace
‚îú‚îÄ‚îÄ tsconfig.json
‚îî‚îÄ‚îÄ README.md
```

### **3. Package.json Setup**

**Root `package.json` (workspace):**

```json
{
  "name": "my-midnight-dapp",
  "version": "1.0.0",
  "private": true,
  "type": "module",
  "workspaces": [
    "contract",
    "cli",
    "api",
    "ui"
  ],
  "devDependencies": {
    "@types/node": "^24.9.1",
    "typescript": "^5.9.3",
    "vitest": "^4.0.3"
  },
  "scripts": {
    "test": "vitest run",
    "build": "npm run build --workspaces",
    "clean": "rm -rf */dist */node_modules"
  }
}
```

**Contract `package.json`:**

```json
{
  "name": "@my-dapp/contract",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "compact": "compact compile src/mycontract.compact src/managed/mycontract",
    "build": "npm run compact && tsc",
    "test": "vitest run"
  },
  "dependencies": {
    "@midnight-ntwrk/compact-runtime": "^0.9.0"
  },
  "devDependencies": {
    "typescript": "^5.9.3"
  }
}
```

---

## üìù Compact Smart Contracts

### **Basic Contract Structure**

**Minimal Counter Example:**

```compact
pragma language_version >= 0.16 && <= 0.18;
import CompactStandardLibrary;

// Public state
export ledger counter: Counter;

// Constructor (optional)
constructor() {
  counter.increment(0);  // Initialize to 0
}

// Public circuit (exported function)
export circuit increment(): [] {
  counter.increment(1);
}
```

### **Contract Components**

#### **1. Pragma & Imports**

```compact
// ALWAYS use range syntax
pragma language_version >= 0.16 && <= 0.18;

// Standard library (required for most types)
import CompactStandardLibrary;

// Import other contracts (for composition)
import MyOtherContract;
```

#### **2. State Variables (Ledgers)**

```compact
// Public ledger (on-chain, visible to all)
export ledger publicState: Uint<64>;

// Private ledger (sealed, encrypted on-chain)
ledger privateState: Map<Bytes<32>, Bytes<64>>;

// Sealed ledger (contract composition)
sealed ledger otherContract: MyOtherContract;
```

#### **3. Data Structures**

```compact
// Struct definition
export struct UserRecord {
  address: Address;
  balance: Uint<64>;
  isActive: Boolean;
}

// Enum definition
export enum Status {
  ACTIVE,
  SUSPENDED,
  CLOSED
}

// Using structs in ledgers
ledger users: Map<Address, UserRecord>;
```

#### **4. Constructor**

```compact
// Initialize state (called once on deployment)
constructor(initialOwner: Address) {
  owner = initialOwner;
  counter.increment(0);
  users = Map.empty<Address, UserRecord>();
}
```

#### **5. Circuits (Functions)**

```compact
// Public circuit (exported, callable by anyone)
export circuit publicFunction(param: Uint<64>): Uint<64> {
  counter.increment(param);
  return counter as Uint<64>;
}

// Private circuit (internal helper)
circuit privateHelper(x: Uint<64>, y: Uint<64>): Uint<64> {
  return x + y;
}

// Circuit with witness (private input)
witness getSecretKey(): Bytes<32>;

export circuit signedAction(): [] {
  const key = getSecretKey();  // Private input
  // Use key for verification
}
```

### **Type System**

#### **Primitive Types**

```compact
Uint<8>      // 8-bit unsigned integer
Uint<16>     // 16-bit unsigned integer
Uint<32>     // 32-bit unsigned integer
Uint<64>     // 64-bit unsigned integer
Uint<128>    // 128-bit unsigned integer (max supported)

Bytes<32>    // Fixed-size byte array (32 bytes)
Bytes<64>    // Fixed-size byte array (64 bytes)

Boolean      // true/false
Field        // Field element (ZK proof arithmetic)
```

#### **Collection Types**

```compact
Map<K, V>              // Key-value map
Counter                // Auto-incrementing counter
Maybe<T>               // Optional value (some/none)
Opaque<"string">       // Opaque type for privacy
```

#### **Special Types**

```compact
Address                // Midnight wallet address
Signature              // Cryptographic signature
PublicKey              // Public key
```

### **Common Patterns**

#### **Map Operations**

```compact
// Check if key exists
if (myMap.has(key)) {
  // Key exists
}

// Get value (must exist)
const value = myMap.get(key);

// Set value
myMap.set(key, value);

// Remove key
myMap.remove(key);
```

#### **Counter Operations**

```compact
// Increment
counter.increment(5);

// Get current value
const current = counter as Uint<64>;
```

#### **Maybe Operations**

```compact
// Create optional value
const something = some<Uint<64>>(42);
const nothing = none<Uint<64>>();

// Check if value exists
if (isSome(maybeValue)) {
  const unwrapped = unwrap(maybeValue);
}
```

#### **Assertions**

```compact
// Validate conditions
assert(balance >= amount, "Insufficient balance");
assert(sender == owner, "Not authorized");
assert(now < expiry, "Expired");
```

---

## üîß Midnight.js SDK

### **Core Packages**

From `@midnight-ntwrk` namespace:

```typescript
// Contract execution & state management
import { Contract, Ledger } from '@midnight-ntwrk/midnight-js-contracts';

// Type definitions
import type { Address, HexString } from '@midnight-ntwrk/midnight-js-types';

// Wallet integration
import { Wallet } from '@midnight-ntwrk/wallet';
import { WalletAPI } from '@midnight-ntwrk/wallet-api';

// Data providers
import { IndexerPublicDataProvider } from '@midnight-ntwrk/midnight-js-indexer-public-data-provider';
import { LevelPrivateStateProvider } from '@midnight-ntwrk/midnight-js-level-private-state-provider';

// Proof generation
import { HttpClientProofProvider } from '@midnight-ntwrk/midnight-js-http-client-proof-provider';

// ZK configuration
import { NodeZkConfigProvider } from '@midnight-ntwrk/midnight-js-node-zk-config-provider';

// Ledger state
import { Ledger as LedgerLib } from '@midnight-ntwrk/ledger';
```

### **Contract Integration**

#### **1. Import Compiled Contract**

```typescript
// Generated by: compact compile src/counter.compact src/managed/counter
import type { Contract, Ledger, Witnesses } from './managed/counter';
import counterContract from './managed/counter/index.cjs';
```

#### **2. Create Contract Instance**

```typescript
import { createContract } from '@midnight-ntwrk/midnight-js-contracts';

const contract = await createContract<Contract, Ledger, Witnesses>(
  counterContract,
  {
    indexerUrl: 'https://indexer.testnet.midnight.network',
    proofServerUrl: 'http://localhost:6300',
    networkId: 'testnet',
  }
);
```

#### **3. Deploy Contract**

```typescript
const deploymentResult = await contract.deploy(
  wallet,                    // Wallet instance
  {},                        // Constructor arguments
  { gasLimit: 1000000 }      // Transaction options
);

console.log('Deployed at:', deploymentResult.contractAddress);
```

#### **4. Call Circuits**

```typescript
// Call exported circuit
const result = await contract.callCircuit(
  'increment',               // Circuit name
  [],                        // Arguments
  wallet,                    // Wallet for signing
  { gasLimit: 500000 }       // Transaction options
);

console.log('Transaction hash:', result.txHash);
```

#### **5. Query State**

```typescript
// Get current ledger state
const ledgerState = await contract.state();
console.log('Counter value:', ledgerState.counter);
```

### **Wallet Setup**

#### **Headless Wallet (CLI)**

```typescript
import { createWalletFromSeed } from '@midnight-ntwrk/wallet';

const wallet = await createWalletFromSeed(
  seed,                      // 64-char hex string
  {
    indexerUrl: 'https://indexer.testnet.midnight.network',
    networkId: 'testnet',
  }
);

// Get balance
const balance = await wallet.balance();
console.log('Balance:', balance);

// Get address
const address = wallet.address();
console.log('Address:', address);
```

#### **Browser Wallet (Lace)**

```typescript
import { connectWallet } from '@midnight-ntwrk/wallet-api';

const wallet = await connectWallet({
  appName: 'My Midnight DApp',
  networkId: 'testnet',
});

// Request authorization
const authorized = await wallet.authorize();
if (authorized) {
  console.log('Wallet connected:', wallet.address());
}
```

---

## üîê Proof Server

### **Setup** (Docker)

**Pull Image:**

```bash
docker pull midnightnetwork/proof-server:latest
```

**Run for Testnet:**

```bash
docker run -d \
  -p 6300:6300 \
  --name midnight-proof-server \
  midnightnetwork/proof-server \
  -- 'midnight-proof-server --network testnet'
```

**Verify Running:**

```bash
docker ps | grep proof-server
curl http://localhost:6300/health
```

### **Docker Compose**

**proof-server-testnet.yml:**

```yaml
version: '3.8'

services:
  proof-server:
    image: midnightnetwork/proof-server:latest
    ports:
      - "6300:6300"
    command: ["midnight-proof-server", "--network", "testnet"]
    restart: unless-stopped
```

**Usage:**

```bash
# Start
docker compose -f proof-server-testnet.yml up -d

# Stop
docker compose -f proof-server-testnet.yml down

# View logs
docker compose -f proof-server-testnet.yml logs -f
```

---

## üß™ Testing & Debugging

### **Contract Unit Tests**

**Example Test (Vitest):**

```typescript
import { describe, it, expect, beforeAll } from 'vitest';
import type { Contract, Ledger } from './managed/counter';
import counterContract from './managed/counter/index.cjs';

describe('Counter Contract', () => {
  let contract: Contract;

  beforeAll(async () => {
    contract = await setupTestContract(counterContract);
  });

  it('should increment counter', async () => {
    await contract.callCircuit('increment', []);
    const state = await contract.state();
    expect(state.counter).toBeGreaterThan(0);
  });

  it('should validate authorization', async () => {
    await expect(
      contract.callCircuit('adminOnly', [], unauthorizedWallet)
    ).rejects.toThrow('Not authorized');
  });
});
```

### **Debugging Tips**

**1. Compiler Errors:**

```bash
# Verbose compilation
compact compile --verbose src/contract.compact src/managed/

# Check syntax
compact check src/contract.compact
```

**2. Runtime Errors:**

```typescript
// Enable debug logging
process.env.DEBUG = '@midnight-ntwrk/*';

// Use try-catch
try {
  await contract.callCircuit('myCircuit', args);
} catch (error) {
  console.error('Circuit error:', error.message);
  console.error('Stack:', error.stack);
}
```

**3. Proof Generation Issues:**

```bash
# Check proof server logs
docker logs midnight-proof-server

# Test proof server connection
curl http://localhost:6300/health
```

---

## üöÄ Deployment

### **Testnet Deployment**

**1. Get Testnet Funds:**

- Visit: https://midnight.network/test-faucet
- Enter your wallet address
- Wait 2-3 minutes for funds

**2. Deploy Script:**

```typescript
import { deployContract } from './deploy-utils';

async function main() {
  const wallet = await createWalletFromSeed(process.env.WALLET_SEED!);
  
  console.log('Deploying to testnet...');
  console.log('Wallet address:', wallet.address());
  console.log('Balance:', await wallet.balance());

  const contractAddress = await deployContract(
    'MyContract',
    contractCode,
    {},  // constructor args
    wallet
  );

  console.log('‚úÖ Deployed at:', contractAddress);
  
  // Save deployment info
  await fs.writeFile('deployment.json', JSON.stringify({
    network: 'testnet',
    contractAddress,
    deployedAt: new Date().toISOString(),
  }));
}

main().catch(console.error);
```

### **Deployment Checklist**

- [ ] Contract compiles successfully
- [ ] All tests pass
- [ ] Wallet has sufficient balance (>100 tDUST)
- [ ] Proof server is running
- [ ] Network URLs configured correctly
- [ ] Constructor arguments prepared
- [ ] Deployment script tested

---

## ‚ú® Best Practices

### **Contract Design**

1. **Keep circuits small** - Complex logic should be off-chain
2. **Use assertions liberally** - Validate all inputs
3. **Minimize state changes** - ZK proofs are expensive
4. **Use sealed ledgers** for contract composition
5. **Document all public circuits** - Include parameter descriptions

### **Code Organization**

```compact
// Group by functionality with clear comments

// ============================================================================
// STATE VARIABLES
// ============================================================================

// ============================================================================
// DATA STRUCTURES
// ============================================================================

// ============================================================================
// CONSTRUCTOR
// ============================================================================

// ============================================================================
// PUBLIC CIRCUITS
// ============================================================================

// ============================================================================
// PRIVATE HELPERS
// ============================================================================
```

### **Security**

1. **Validate all inputs** - Use assertions
2. **Check authorization** - Verify sender/caller
3. **Prevent reentrancy** - Use proper state management
4. **Time-based logic** - Always check expiration
5. **Avoid integer overflow** - Use appropriate Uint sizes

### **TypeScript Integration**

1. **Use strict mode** - `"strict": true` in tsconfig.json
2. **Type imports** - Import types from generated files
3. **Error handling** - Always catch and handle errors
4. **Logging** - Use structured logging
5. **Environment variables** - Never hardcode secrets

---

## üîÑ Common Patterns

### **Multi-Party Delegation**

```compact
struct Delegation {
  grantor: Address;
  grantee: Address;
  scopes: Bytes<32>;
  expiresAt: Uint<64>;
  isRevoked: Boolean;
}

ledger delegations: Map<Bytes<32>, Delegation>;

export circuit createDelegation(
  grantee: Address,
  scopes: Bytes<32>,
  expiresAt: Uint<64>,
  currentTime: Uint<64>
): Bytes<32> {
  assert(expiresAt > currentTime, "Invalid expiration");
  
  const delegationId = hashDelegation(caller, grantee, currentTime);
  const delegation = Delegation {
    grantor: caller,
    grantee: grantee,
    scopes: scopes,
    expiresAt: expiresAt,
    isRevoked: false
  };
  
  delegations.set(delegationId, delegation);
  return delegationId;
}
```

### **Selective Disclosure**

```compact
// Private data (sealed)
ledger privateRecords: Map<Address, Opaque<"PersonalData">>;

// Public verification without revealing data
export circuit verifyAttribute(
  owner: Address,
  attributeHash: Bytes<32>
): Boolean {
  const record = privateRecords.get(owner);
  // ZK proof verifies attribute without revealing full record
  return verifyAttributeProof(record, attributeHash);
}
```

### **Replay Attack Prevention**

```compact
ledger nonces: Map<Address, Uint<64>>;

export circuit executeWithNonce(
  caller: Address,
  nonce: Uint<64>,
  action: Bytes<32>
): [] {
  const currentNonce = nonces.get(caller);
  assert(nonce == currentNonce + 1, "Invalid nonce");
  
  // Execute action
  performAction(action);
  
  // Increment nonce
  nonces.set(caller, nonce);
}
```

---

## üîç Troubleshooting

### **Common Errors**

#### **"unbound identifier Address"**

**Cause**: Compiler v0.26.0 regression  
**Solution**: Use v0.25.0 or range pragma syntax

#### **"connect ECONNREFUSED 127.0.0.1:6300"**

**Cause**: Proof server not running  
**Solution**:
```bash
docker run -p 6300:6300 midnightnetwork/proof-server -- 'midnight-proof-server --network testnet'
```

#### **"Insufficient balance"**

**Cause**: Wallet doesn't have enough tDUST  
**Solution**: Visit https://midnight.network/test-faucet

#### **"Could not find a working container runtime strategy"**

**Cause**: Docker not running properly  
**Solution**: Restart Docker Desktop

#### **"compact: command not found"**

**Cause**: Compact not in PATH  
**Solution**:
```bash
source $HOME/.local/bin/env
compact compile --version
```

---

## üìö Additional Resources

### **Official Documentation**
- Midnight Docs: https://docs.midnight.network
- Compact Reference: https://docs.midnight.network/develop/reference/compact
- API Docs: https://docs.midnight.network/develop/reference/midnight-api

### **Example Projects**
- example-counter: Simple counter DApp
- example-bboard: Bulletin board with privacy
- example-proofshare: Selective disclosure demo

### **Community**
- Discord: https://discord.gg/midnight
- GitHub: https://github.com/midnightntwrk
- Forum: https://forum.midnight.network

---

## üéØ Quick Reference

### **Package Versions**

```json
{
  "dependencies": {
    "@midnight-ntwrk/compact-runtime": "^0.9.0",
    "@midnight-ntwrk/ledger": "^4.0.0",
    "@midnight-ntwrk/midnight-js-contracts": "2.0.2",
    "@midnight-ntwrk/midnight-js-http-client-proof-provider": "2.0.2",
    "@midnight-ntwrk/midnight-js-indexer-public-data-provider": "2.0.2",
    "@midnight-ntwrk/midnight-js-level-private-state-provider": "2.0.2",
    "@midnight-ntwrk/midnight-js-node-zk-config-provider": "2.0.2",
    "@midnight-ntwrk/midnight-js-types": "2.0.2",
    "@midnight-ntwrk/wallet": "5.0.0",
    "@midnight-ntwrk/wallet-api": "5.0.0",
    "@midnight-ntwrk/zswap": "^4.0.0"
  }
}
```

### **Essential Commands**

```bash
# Compile contract
compact compile src/contract.compact src/managed/contract

# Run tests
npm run test

# Start proof server
docker run -p 6300:6300 midnightnetwork/proof-server -- 'midnight-proof-server --network testnet'

# Deploy to testnet
npm run deploy:testnet
```

---

**Last Updated**: October 28, 2025  
**Based on**: Midnight official repositories (24 repos)  
**Compiler Version**: 0.25.0 (stable)  
**SDK Version**: 2.0.2 (latest)

**Compiled by**: Cascade AI for AgenticDID.io project  
**Verified**: All information from official Midnight sources

---

*This compendium is a living document. Update as new versions and patterns emerge.*
